{% extends 'base.html' %}
{% block title %}Panel Hosta - {{ event.name }}{% endblock %}

{% block styles %}
<meta charset="UTF-8">
{{ super() }}
<style>
    .btn-group .btn.active-modifier {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    #info-time-left {
        font-size: 1.2em;
        font-weight: bold;
        color: #dc3545;
    }
    #info-time-elapsed, #info-time-elapsed-pauses {
        font-weight: 500;
    }
    .question-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }
    .question-stats {
        font-size: 0.875rem;
        color: #6c757d;
    }
    /* Style dla statusu gry */
    #info-game-status {
        font-weight: 600;
    }
    #info-game-status.status-waiting {
        color: #6c757d;
    }
    #info-game-status.status-active {
        color: #198754;
    }
    #info-game-status.status-paused {
        color: #ffc107;
    }
    #info-game-status.status-stopped {
        color: #dc3545;
    }

    /* Niebieski kolor zak≈Çadki AI */
    button[data-bs-target="#ai"] {
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }
    button[data-bs-target="#ai"]:hover {
        background-color: #0b5ed7 !important;
        border-color: #0a58ca !important;
    }
    button[data-bs-target="#ai"].active {
        background-color: #0a58ca !important;
        border-color: #0a53be !important;
    }

    /* ‚úÖ NOWE: Style dla klikalnego pola has≈Ça */
    #password-preview-card {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    #password-preview-card:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    {% if is_impersonated %}
    <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <span data-translate="admin_impersonate">Jeste≈õ zalogowany jako Admin w panelu Hosta.</span>
        <a href="{{ url_for('logout_impersonate') }}" class="btn btn-sm btn-warning" data-translate="back_to_admin">Powr√≥t do panelu Admina</a>
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0" data-translate="host_title">ORGANIZACJA GRY</h1>
            <h3 class="text-muted mb-0">{{ event.name }}</h3>
        </div>
        <a href="{{ url_for('display', event_id=event.id) }}" target="_blank" class="btn btn-outline-secondary" data-translate="open_display">Otw√≥rz Ekran Gry</a>
    </div>

    <ul class="nav nav-tabs mb-4" id="hostTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#game" data-translate="tab_game">Gra</button></li>
        {% if is_superhost %}
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#qrcodes" data-translate="tab_qrcodes">Kody QR</button></li>
        {% endif %}
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#password" data-translate="tab_password">Has≈Ço</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#players" data-translate="tab_players">Gracze</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#questions" data-translate="tab_questions">Pytania</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ai" data-translate="tab_ai">AI</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#minigames" data-translate="tab_minigames">Minigry</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#timing" data-translate="tab_timing">Czas i tempo</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#photo" data-translate="tab_photo">Foto</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ar" data-translate="tab_ar">AR</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#display" data-translate="tab_display">Wy≈õwietlacz</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#language" data-translate="tab_language">Jƒôzyk</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="game">
            <!-- 1. INFORMACJE O GRZE (bez zmian) -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0" data-translate="game_info">Informacje o grze</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="player_count">Liczba graczy:</span> 
                                    <span id="info-player-count" class="badge bg-primary rounded-pill">0</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="completion_percentage">Procent uko≈Ñczenia:</span> 
                                    <span id="info-completion-percentage" class="badge bg-success rounded-pill">0%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="language_host_label">Jƒôzyk prowadzƒÖcego:</span> 
                                    <span id="info-language" class="badge bg-secondary">Polski</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                             <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="time_left">Czas do ko≈Ñca:</span> 
                                    <strong id="info-time-left">00:00</strong>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="time_net">Czas gry (netto):</span> 
                                    <span id="info-time-elapsed">00:00</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="time_gross">Czas gry (brutto):</span> 
                                    <span id="info-time-elapsed-pauses">00:00</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                             <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="current_bonus">Aktualna premia:</span> 
                                    <span id="info-bonus" class="badge bg-success">Brak</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="current_speed">Aktualne tempo:</span> 
                                    <span id="info-speed" class="badge bg-info">x1</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span data-translate="game_status_label">Stan gry:</span> 
                                    <span id="info-game-status" class="status-waiting">Oczekiwanie na Start</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        
            <!-- 2. OBS≈ÅUGA GRY (nowa pozycja - pe≈Çna szeroko≈õƒá) -->
            <fieldset id="pre-game-settings">
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0" data-translate="pre_game_settings">Obs≈Çuga gry</h5></div>
                    <div class="card-body">
                        <!-- Pierwszy rzƒÖd: g≈Ç√≥wne przyciski sterowania -->
                        <div class="row g-2 mb-3">
                            <div class="col-3">
                                <button id="start-game" class="btn btn-success w-100" data-translate="start_game">Start Gry</button>
                            </div>
                            <div class="col-3">
                                <button id="pause-btn" data-control="pause" class="btn btn-warning w-100" data-translate="pause">Pauza</button>
                            </div>
                            <div class="col-3">
                                <button id="stop-game" class="btn btn-danger w-100" data-translate="stop_game">Stop Gry</button>
                            </div>
                            <div class="col-3">
                                <button id="reset-game" class="btn btn-dark w-100" data-translate="reset_game">Reset Gry</button>
                            </div>
                        </div>
        
                        <hr>
        
                        <!-- Drugi rzƒÖd: szybki dostƒôp do zak≈Çadek -->
                        <div class="row g-2">
                            {% if is_superhost %}
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="qrcodes" data-translate="tab_qrcodes">Kody QR</button>
                            </div>
                            {% endif %}
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="password" data-translate="tab_password">Has≈Ço</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="players" data-translate="tab_players">Gracze</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="questions" data-translate="tab_questions">Pytania</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="minigames" data-translate="tab_minigames">Minigry</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="photo" data-translate="tab_photo">Foto</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="ar" data-translate="tab_ar">AR</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="display" data-translate="tab_display">Wy≈õwietlacz</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="language" data-translate="tab_language">Jƒôzyk</button>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-secondary btn-sm text-white quick-tab-btn" data-tab="timing" data-translate="tab_timing">Czas i tempo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
        
            <!-- 3. POLE HAS≈ÅO (pe≈Çna szeroko≈õƒá, klikalne) -->
            <div class="card mb-4" id="password-preview-card">
                <div class="card-header">
                    <h5 class="card-title mb-0" data-translate="password_preview">Has≈Ço</h5>
                </div>
                <div class="card-body text-center">
                    <div id="game-password-display" 
                         class="d-flex flex-wrap gap-1 justify-content-center" 
                         style="font-size: 1.2rem; font-family: monospace;">
                        <!-- Litery bƒôdƒÖ generowane dynamicznie -->
                    </div>
                </div>
            </div>
            
            <!-- 4. KOMUNIKATY NA EKRAN GRY (pe≈Çna szeroko≈õƒá) -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0" data-translate="host_messages">Komunikaty na ekran gry</h5></div>
                <div class="card-body">
                    <p class="text-muted small mb-3" data-translate="messages_description">
                        Wy≈õlij komunikat, kt√≥ry pojawi siƒô na g≈Ç√≥wnym ekranie gry. U≈ºyj tego, aby przekazaƒá wa≈ºne informacje wszystkim uczestnikom.
                    </p>
                    <div class="mb-3">
                        <label for="host-message-input" class="form-label" data-translate="message_label">Tre≈õƒá komunikatu (max 500 znak√≥w):</label>
                        <textarea class="form-control" id="host-message-input" rows="3" maxlength="500" placeholder="Wpisz komunikat..."></textarea>
                        <small class="text-muted">
                            <span id="message-char-count">0</span> / 500 znak√≥w
                        </small>
                    </div>
                    <button class="btn btn-primary" id="send-message-btn" data-translate="send_message">Wy≈õlij komunikat</button>
                    <div id="message-status" class="mt-2"></div>
                </div>
            </div>
                
            <!-- 5. TEMPO GRY ORAZ PUNKTACJA (pe≈Çna szeroko≈õƒá) -->
            <fieldset id="in-game-settings" disabled>
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0" data-translate="in_game_settings">Tempo gry oraz punktacja</h5></div>
                    <div class="card-body" id="game-controls">
                        <label class="form-label" data-translate="time_speed">Tempo czasu:</label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="1">x1</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="2">x2</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="10">x10</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="30">x30</button>
                        </div>
                        <label class="form-label" data-translate="points_bonus">Premia punktowa:</label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="1">x1</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="2">x2</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="3">x3</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="10">x10</button>
                        </div>
                    </div>
                </div>
            </fieldset>   
        </div>  <!-- ‚úÖ To musi mieƒá zamkniƒôcie -->
        
        {% if is_superhost %}
        <div class="tab-pane fade" id="qrcodes">
            <div class="card mx-auto">
                <div class="card-header">
                    <h5 class="card-title mb-0" data-translate="qr_management">ZarzƒÖdzanie Kodami QR</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info small"><b>Uwaga:</b> Kody bia≈Çe i ≈º√≥≈Çte sƒÖ wielorazowe (z 5-minutowym limitem na gracza). Pozosta≈Çe kody sƒÖ unikalne i jednorazowe.</div>
                    
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Kody Czerwone (punkty specjalne)</label><input type="number" id="red-count" class="form-control" value="0" min="0"></div>
                        <div class="col-md-6"><label class="form-label">Kody Bia≈Çe Pu≈Çapka (punkty ujemne)</label><input type="number" id="white_trap-count" class="form-control" value="0" min="0"></div>
                        <div class="col-md-6"><label class="form-label">Kody Zielone (minigry)</label><input type="number" id="green-count" class="form-control" value="0" min="0"></div>
                        <div class="col-md-6"><label class="form-label">Kody R√≥≈ºowe (wyzwanie foto)</label><input type="number" id="pink-count" class="form-control" value="0" min="0"></div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button id="save-qrcodes" class="btn btn-primary">Wygeneruj i Zapisz Kody</button>
                        <a href="#" id="preview-qrcodes-link" target="_blank" class="btn btn-secondary">PodglƒÖd i Druk Kod√≥w</a>
                    </div>
                    <div id="qrcodes-status" class="mt-3"></div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="tab-pane fade" id="password">
            <div class="card mb-3">
                <div class="card-header"><h5 class="card-title mb-0">1. Edycja has≈Ça</h5></div>
                <div class="card-body">
                    <p class="text-muted small">Wpisz has≈Ço, kt√≥re gracze bƒôdƒÖ ods≈Çaniaƒá podczas gry (mo≈ºliwe tylko przed startem gry).</p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="password-edit-input" maxlength="50" placeholder="np. SAPEREVENT" value="SAPEREVENT">
                        <button class="btn btn-primary" id="password-edit-ok-btn">OK</button>
                    </div>
                    <small class="text-muted">Max 50 znak√≥w. Spacje sƒÖ dozwolone.</small>
                    <div id="password-edit-status" class="mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0">2. Kontrola has≈Ça</h5></div>
                <div class="card-body">
                    <p class="text-muted small">ZarzƒÖdzaj odkrywaniem liter has≈Ça. Odkrywanie rƒôczne jest zawsze dostƒôpne.</p>
                    
                    <!-- Prze≈ÇƒÖcznik automatycznego odkrywania -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">Odkrywanie automatyczne:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="password-auto-reveal-toggle" 
                                       style="width: 3em; height: 1.5em;" checked>
                                <label class="form-check-label ms-2" for="password-auto-reveal-toggle">
                                    <span id="auto-reveal-status" class="badge bg-success">W≈ÇƒÖczone</span>
                                </label>
                            </div>
                        </div>
                        <small class="text-muted d-block">
                            Gdy w≈ÇƒÖczone: litery odkrywane automatycznie gdy gracz zdobƒôdzie 50% mo≈ºliwych punkt√≥w (oznaczone na zielono).<br>
                            Odkrywanie rƒôczne jest zawsze dostƒôpne niezale≈ºnie od ustawienia.
                        </small>
                    </div>

                    <hr>

                    <!-- Sekcja odkrywania has≈Ça -->
                    <h6 class="mb-3">Has≈Ço do ods≈Çoniƒôcia:</h6>
                    <p class="text-muted small mb-3">
                        üü¢ Zielone - ods≈Çoniƒôte | üî¥ Czerwone - zakryte<br>
                        Kliknij na czerwonƒÖ literƒô, aby jƒÖ ods≈Çoniƒá rƒôcznie. Ka≈ºda litera jest traktowana indywidualnie.
                    </p>
                    <div id="password-letters-display" class="d-flex flex-wrap gap-2 justify-content-center mb-3" style="font-size: 1.8rem; font-family: monospace;">
                        <!-- Litery bƒôdƒÖ generowane dynamicznie -->
                    </div>
                    <button class="btn btn-success w-100" id="reveal-selected-letters-btn" disabled>
                        Potwierd≈∫ ods≈Çoniƒôcie wybranych liter
                    </button>
                    <div id="password-reveal-status" class="mt-2"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="players">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" data-translate="players_management">ZarzƒÖdzanie graczami</h5>
                </div>
                <div class="card-body">
                    <div id="players-list"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="questions">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0" data-translate="questions_management">ZarzƒÖdzanie pytaniami</h5>
                    <button class="btn btn-primary" id="add-question-btn" data-translate="add_question">Dodaj pytanie</button>
                </div>
                <div class="card-body">
                    <div id="questions-list"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="ai">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">AI Quiz - Kategorie domy≈õlne</h5>
                    <small class="text-muted">10 kategorii z gotowymi pytaniami (darmowe)</small>
                </div>
                <div class="card-body">
                    <div id="ai-default-categories" class="row g-3">
                        <!-- Kategorie domy≈õlne bƒôdƒÖ tu za≈Çadowane przez JS -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0">W≈Çasne kategorie</h5>
                        <small class="text-muted">Kategorie stworzone przez Ciebie (pytania generowane przez Claude API - p≈Çatne)</small>
                    </div>
                    <button class="btn btn-primary" id="add-custom-category-btn">
                        <i class="bi bi-plus-circle"></i> Dodaj kategoriƒô
                    </button>
                </div>
                <div class="card-body">
                    <div id="ai-custom-categories">
                        <!-- Custom kategorie bƒôdƒÖ tu za≈Çadowane przez JS -->
                        <p class="text-muted text-center" id="no-custom-categories">Brak w≈Çasnych kategorii</p>
                    </div>
                </div>
            </div>

            <!-- Modal: Dodaj custom kategoriƒô -->
            <div class="modal fade" id="addCustomCategoryModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Dodaj w≈ÇasnƒÖ kategoriƒô</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="custom-category-name" class="form-label">Nazwa kategorii</label>
                                <input type="text" class="form-control" id="custom-category-name" placeholder="np. Medycyna, Motoryzacja">
                            </div>
                            <div class="mb-3">
                                <label for="custom-category-difficulty" class="form-label">Poziom trudno≈õci</label>
                                <select class="form-select" id="custom-category-difficulty">
                                    <option value="easy">≈Åatwy</option>
                                    <option value="medium" selected>≈öredni</option>
                                    <option value="advanced">Zaawansowany</option>
                                </select>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="use-claude-api" checked>
                                <label class="form-check-label" for="use-claude-api">
                                    Generuj pytania przez Claude API (p≈Çatne, wysokiej jako≈õci)
                                </label>
                                <small class="form-text text-muted d-block">
                                    Je≈õli odznaczone, pytania bƒôdƒÖ musia≈Çy byƒá dodane rƒôcznie przez Admina.
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                            <button type="button" class="btn btn-primary" id="confirm-add-custom-category">Dodaj</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="minigames">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0">ZarzƒÖdzanie minigrami</h5></div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Informacja:</strong> Minigry aktywowane przez zielone kody QR. 
                        Ka≈ºda minigra wymaga zdobycia 20 punkt√≥w, aby otrzymaƒá nagrodƒô.
                    </div>
                    
                    <!-- TETRIS -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">üéÆ Tetris</h5>
                                    <p class="text-muted mb-0">Cel: 20 punkt√≥w (u≈Ç√≥≈º linie)</p>
                                    <small class="text-muted">Sterowanie: strza≈Çki + obr√≥t</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="tetris-toggle" 
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="tetris-toggle">
                                        <span id="tetris-status" class="badge bg-secondary">Nieaktywny</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <!-- ARKANOID -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">üèì Arkanoid</h5>
                                    <p class="text-muted mb-0">Cel: 20 punkt√≥w (zbij ceg≈Çy)</p>
                                    <small class="text-muted">3 ≈ºycia | Sterowanie: przyciski ‚óÑ ‚ñ∫</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="arkanoid-toggle"
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="arkanoid-toggle">
                                        <span id="arkanoid-status" class="badge bg-secondary">Nieaktywny</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SNAKE -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">üêç Snake</h5>
                                    <p class="text-muted mb-0">Cel: 20 punkt√≥w (zjedz jedzenie)</p>
                                    <small class="text-muted">Sterowanie: przyciski ‚óÑ ‚ñ≤ ‚ñº ‚ñ∫</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="snake-toggle"
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="snake-toggle">
                                        <span id="snake-status" class="badge bg-secondary">Nieaktywny</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3" id="minigames-info" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="photo">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0" data-translate="photo_tab">Galeria zdjƒôƒá</h5></div>
                <div class="card-body">
                    <p data-translate="photo_description">Tutaj bƒôdƒÖ widoczne zdjƒôcia przes≈Çane przez graczy.</p>
                    <div class="alert alert-secondary text-center">
                        <p class="mb-0">Wkr√≥tce - galeria zdjƒôƒá z g≈Çosowaniem</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="ar">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0" data-translate="ar_tab">Rozszerzona rzeczywisto≈õƒá (AR)</h5></div>
                <div class="card-body">
                    <p data-translate="ar_description">Tutaj bƒôdƒÖ dostƒôpne funkcje AR.</p>
                    <div class="alert alert-secondary text-center">
                        <p class="mb-0">Wkr√≥tce - funkcje AR</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="timing">
            <fieldset id="timing-settings" disabled>
                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0" data-translate="timing_settings">Czas i tempo gry</h5></div>
                    <div class="card-body" id="timing-controls">
                        <div class="mb-3">
                            <label for="game-duration-input-2" class="form-label" data-translate="game_duration_label">Czas gry (minuty):</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="game-duration-input-2" value="60" min="1">
                                <button class="btn btn-primary" id="set-time-btn-2" data-translate="set_time_btn">OK</button>
                            </div>
                            <small class="text-muted" data-translate="game_duration_help">Przed grƒÖ: ustaw czas. Podczas gry: zmie≈Ñ czas (wymaga has≈Ça)</small>
                        </div>
        
                        <hr>
        
                        <label class="form-label" data-translate="time_speed">Tempo czasu:</label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="1">x1</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="2">x2</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="10">x10</button>
                            <button type="button" class="btn btn-outline-info" data-control="speed" data-value="30">x30</button>
                        </div>
                        <label class="form-label" data-translate="points_bonus">Premia punktowa:</label>
                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="1">x1</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="2">x2</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="3">x3</button>
                            <button type="button" class="btn btn-outline-primary" data-control="bonus" data-value="10">x10</button>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>

        <!-- ‚úÖ NOWA ZAK≈ÅADKA: WY≈öWIETLACZ -->
        <div class="tab-pane fade" id="display">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" data-translate="display_tab">Ustawienia wy≈õwietlacza</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 data-translate="display_screens">Liczba ekran√≥w zewnƒôtrznych:</h6>
                        <div class="btn-group w-100" role="group" id="display-screens-controls">
                            <button type="button" class="btn btn-outline-primary" data-control="display_screens" data-value="1" data-translate="one_screen">1 Ekran</button>
                            <button type="button" class="btn btn-outline-primary active-modifier" data-control="display_screens" data-value="2" data-translate="two_screens">2 Ekrany</button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <strong>1 ekran:</strong> Bomba, has≈Ço, ranking i zdjƒôcia na jednym ekranie<br>
                            <strong>2 ekrany:</strong> Ekran 1 - Bomba i has≈Ço | Ekran 2 - Ranking, zdjƒôcia i kod QR dla graczy
                        </small>
                    </div>

                    <div class="mt-4">
                        <h6>Linki do ekran√≥w:</h6>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('display', event_id=event.id) }}" target="_blank" class="btn btn-secondary" id="display1-link">
                                üñ•Ô∏è Ekran 1 - G≈Ç√≥wny wy≈õwietlacz
                            </a>
                            <a href="{{ url_for('display2', event_id=event.id) }}" target="_blank" class="btn btn-secondary" id="display2-link">
                                üñ•Ô∏è Ekran 2 - Ranking i zdjƒôcia
                            </a>
                        </div>
                    </div>

                    <div id="display-status" class="mt-3 alert alert-info">
                        Aktualnie uruchomione: <strong>2 ekrany</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="language">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0" data-translate="language_tab">Ustawienia jƒôzyka</h5></div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 data-translate="player_language">Jƒôzyk graczy</h6>
                        <div class="btn-group w-100" role="group" id="lang-player-controls">
                            <button type="button" class="btn btn-outline-primary active-modifier" data-control="language_player" data-value="pl" data-translate="lang_polish">Jƒôzyk polski</button>
                            <button type="button" class="btn btn-outline-primary" data-control="language_player" data-value="en" data-translate="lang_english">Jƒôzyk angielski</button>
                            <button type="button" class="btn btn-outline-primary" data-control="language_player" data-value="de" data-translate="lang_german">Jƒôzyk niemiecki</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 data-translate="host_language">Jƒôzyk prowadzƒÖcego</h6>
                        <div class="btn-group w-100" role="group" id="lang-host-controls">
                            <button type="button" class="btn btn-outline-primary active-modifier" data-control="language_host" data-value="pl" data-translate="lang_polish">Jƒôzyk polski</button>
                            <button type="button" class="btn btn-outline-primary" data-control="language_host" data-value="en" data-translate="lang_english">Jƒôzyk angielski</button>
                            <button type="button" class="btn btn-outline-primary" data-control="language_host" data-value="de" data-translate="lang_german">Jƒôzyk niemiecki</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding/editing question -->
<div class="modal fade" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" data-translate="question_modal_title">Dodaj pytanie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" data-translate="question_text">Tre≈õƒá pytania:</label>
                    <textarea class="form-control" id="modal-question-text" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-translate="answers">Odpowiedzi:</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text">A)</span>
                        <input type="text" class="form-control" id="modal-answer-a">
                        <div class="input-group-text">
                            <input class="form-check-input" type="radio" name="correct-answer" value="A" id="correct-a">
                        </div>
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text">B)</span>
                        <input type="text" class="form-control" id="modal-answer-b">
                        <div class="input-group-text">
                            <input class="form-check-input" type="radio" name="correct-answer" value="B" id="correct-b">
                        </div>
                    </div>
                    <div class="input-group">
                        <span class="input-group-text">C)</span>
                        <input type="text" class="form-control" id="modal-answer-c">
                        <div class="input-group-text">
                            <input class="form-check-input" type="radio" name="correct-answer" value="C" id="correct-c">
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-translate="difficulty_level">Poziom trudno≈õci:</label>
                    <div class="btn-group w-100" role="group" id="difficulty-buttons">
                        <button type="button" class="btn btn-outline-success active" data-difficulty="easy" data-translate="easy">≈Åatwy</button>
                        <button type="button" class="btn btn-outline-warning" data-difficulty="medium" data-translate="medium">≈öredni</button>
                        <button type="button" class="btn btn-outline-danger" data-difficulty="hard" data-translate="hard">Trudny</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-translate="question_category">Kategoria pytania:</label>
                    <div class="btn-group w-100" role="group" id="category-buttons">
                        <button type="button" class="btn btn-outline-primary active" data-category="company" data-translate="category_company">Firmowe</button>
                        <button type="button" class="btn btn-outline-primary" data-category="world" data-translate="category_world">≈öwiatowe</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label" data-translate="letter_reveal">Litera do ods≈Çoniƒôcia:</label>
                    <input type="text" class="form-control" id="modal-letter" maxlength="1" value="X">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">Anuluj</button>
                <button type="button" class="btn btn-primary" id="save-question-btn" data-translate="save">Zapisz</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.socket.io/4.5.2/socket.io.min.js"></script>
<script>
// Translations
    const translations = {
    pl: {
        host_title: 'ORGANIZACJA GRY',
        open_display: 'Otw√≥rz Ekran Gry',
        tab_game: 'Gra',
        tab_players: 'Gracze',
        tab_questions: 'Pytania',
        tab_minigames: 'Minigry',
        tab_qrcodes: 'Kody QR',
        tab_password: 'Has≈Ço',
        tab_photo: 'Foto',
        tab_ar: 'AR',
        tab_display: 'Wy≈õwietlacz',
        tab_language: 'Jƒôzyk',
        qr_management: 'ZarzƒÖdzanie Kodami QR',
        password_tab: 'Has≈Ço do ods≈Çoniƒôcia',
        password_description: 'Tutaj bƒôdzie widoczne has≈Ço, kt√≥re gracze muszƒÖ ods≈Çoniƒá podczas gry.',
        photo_tab: 'Galeria zdjƒôƒá',
        photo_description: 'Tutaj bƒôdƒÖ widoczne zdjƒôcia przes≈Çane przez graczy.',
        ar_tab: 'Rozszerzona rzeczywisto≈õƒá (AR)',
        ar_description: 'Tutaj bƒôdƒÖ dostƒôpne funkcje AR.',
        display_tab: 'Ustawienia wy≈õwietlacza',
        display_screens: 'Liczba ekran√≥w zewnƒôtrznych:',
        one_screen: '1 Ekran',
        two_screens: '2 Ekrany',
        language_tab: 'Ustawienia jƒôzyka',
        game_info: 'Informacje o grze',
        player_count: 'Liczba graczy:',
        completion_percentage: 'Procent uko≈Ñczenia:',
        language_host_label: 'Jƒôzyk prowadzƒÖcego:',
        time_left: 'Czas do ko≈Ñca:',
        time_net: 'Czas gry (netto):',
        time_gross: 'Czas gry (brutto):',
        current_bonus: 'Aktualna premia:',
        current_speed: 'Aktualne tempo:',
        game_status_label: 'Stan gry:',
        game_status_waiting: 'Oczekiwanie na Start',
        game_status_active: 'Start. Gra aktywna',
        game_status_paused: 'Pauza',
        game_status_stopped: 'Stop. Zako≈Ñczenie gry',
        pre_game_settings: 'Obs≈Çuga gry',
        game_duration_label: 'Czas gry (minuty):',
        game_duration_help: 'Przed grƒÖ: ustaw czas. Podczas gry: zmie≈Ñ czas (wymaga has≈Ça)',
        set_time_btn: 'OK',
        player_language: 'Jƒôzyk graczy',
        host_language: 'Jƒôzyk prowadzƒÖcego',
        lang_polish: 'Jƒôzyk polski',
        lang_english: 'Jƒôzyk angielski',
        lang_german: 'Jƒôzyk niemiecki',
        start_game: 'Start Gry',
        in_game_settings: 'Tempo gry oraz punktacja',
        points_bonus: 'Premia punktowa:',
        time_speed: 'Tempo czasu:',
        pause: 'Pauza',
        resume: 'Wzn√≥w',
        force_win: 'Przedwczesna wygrana',
        stop_game: 'Stop Gry',
        reset_game: 'Reset Gry',
        quick_access: 'Szybki dostƒôp do zak≈Çadek:',
        questions_management: 'ZarzƒÖdzanie pytaniami',
        players_management: 'ZarzƒÖdzanie graczami',
        add_question: 'Dodaj pytanie',
        question_modal_title: 'Dodaj pytanie',
        question_text: 'Tre≈õƒá pytania:',
        answers: 'Odpowiedzi:',
        difficulty_level: 'Poziom trudno≈õci:',
        easy: '≈Åatwy',
        medium: '≈öredni',
        hard: 'Trudny',
        letter_reveal: 'Litera do ods≈Çoniƒôcia:',
        cancel: 'Anuluj',
        save: 'Zapisz',
        edit: 'Edytuj',
        delete: 'Usu≈Ñ',
        shown: 'Wy≈õwietlono',
        correct: 'Poprawne',
        times: 'razy',
        admin_impersonate: 'Jeste≈õ zalogowany jako Admin w panelu Hosta.',
        back_to_admin: 'Powr√≥t do panelu Admina',
        warn: 'Ostrze≈º',
        warnings: 'Ostrze≈ºenia',
        question_category: 'Kategoria pytania:',
        category_company: 'Firmowe',
        category_world: '≈öwiatowe',
        host_messages: 'Komunikaty na ekran gry',
        messages_description: 'Wy≈õlij komunikat, kt√≥ry pojawi siƒô na g≈Ç√≥wnym ekranie gry. U≈ºyj tego, aby przekazaƒá wa≈ºne informacje wszystkim uczestnikom.',
        message_label: 'Tre≈õƒá komunikatu (max 500 znak√≥w):',
        send_message: 'Wy≈õlij komunikat',
        password_preview: 'Has≈Ço',  // ‚¨ÖÔ∏è DODAJ Tƒò LINIƒò
        tab_timing: 'Czas i tempo',
        timing_settings: 'Czas i tempo gry',
    },
    en: {
        host_title: 'GAME ORGANIZATION',
        open_display: 'Open Game Display',
        tab_game: 'Game',
        tab_players: 'Players',
        tab_questions: 'Questions',
        tab_minigames: 'Minigames',
        tab_qrcodes: 'QR Codes',
        tab_password: 'Password',
        tab_photo: 'Photo',
        tab_ar: 'AR',
        tab_display: 'Display',
        tab_language: 'Language',
        qr_management: 'QR Codes Management',
        password_tab: 'Password to reveal',
        password_description: 'Here you will see the password that players must reveal during the game.',
        photo_tab: 'Photo gallery',
        photo_description: 'Here you will see photos uploaded by players.',
        ar_tab: 'Augmented Reality (AR)',
        ar_description: 'AR features will be available here.',
        display_tab: 'Display settings',
        display_screens: 'Number of external screens:',
        one_screen: '1 Screen',
        two_screens: '2 Screens',
        language_tab: 'Language settings',
        game_info: 'Game information',
        player_count: 'Number of players:',
        completion_percentage: 'Completion percentage:',
        language_host_label: 'Host language:',
        time_left: 'Time left:',
        time_net: 'Game time (net):',
        time_gross: 'Game time (gross):',
        current_bonus: 'Current bonus:',
        current_speed: 'Current speed:',
        game_status_label: 'Game status:',
        game_status_waiting: 'Waiting for Start',
        game_status_active: 'Start. Game active',
        game_status_paused: 'Pause',
        game_status_stopped: 'Stop. Game ended',
        pre_game_settings: 'Game Control',
        game_duration_label: 'Game time (minutes):',
        game_duration_help: 'Before game: set time. During game: change time (requires password)',
        set_time_btn: 'OK',
        player_language: 'Players language',
        host_language: 'Host language',
        lang_polish: 'Polish language',
        lang_english: 'English language',
        lang_german: 'German language',
        start_game: 'Start Game',
        in_game_settings: 'Game Speed and Scoring',
        points_bonus: 'Points bonus:',
        time_speed: 'Time speed:',
        pause: 'Pause',
        resume: 'Resume',
        force_win: 'Force Win',
        stop_game: 'Stop Game',
        reset_game: 'Reset Game',
        quick_access: 'Quick access to tabs:',
        questions_management: 'Questions management',
        players_management: 'Players management',
        add_question: 'Add question',
        question_modal_title: 'Add question',
        question_text: 'Question text:',
        answers: 'Answers:',
        difficulty_level: 'Difficulty level:',
        easy: 'Easy',
        medium: 'Medium',
        hard: 'Hard',
        letter_reveal: 'Letter to reveal:',
        cancel: 'Cancel',
        save: 'Save',
        edit: 'Edit',
        delete: 'Delete',
        shown: 'Shown',
        correct: 'Correct',
        times: 'times',
        admin_impersonate: 'You are logged in as Admin in Host panel.',
        back_to_admin: 'Back to Admin panel',
        warn: 'Warn',
        warnings: 'Warnings',
        question_category: 'Question category:',
        category_company: 'Company',
        category_world: 'World',
        host_messages: 'Messages on game screen',
        messages_description: 'Send a message that will appear on the main game screen. Use this to share important information with all participants.',
        message_label: 'Message content (max 500 characters):',
        send_message: 'Send message',
        password_preview: 'Password',
        tab_timing: 'Time & Speed',
        timing_settings: 'Game Time and Speed',
    },
    de: {
        host_title: 'SPIELORGANISATION',
        open_display: 'Spielanzeige √∂ffnen',
        tab_game: 'Spiel',
        tab_players: 'Spieler',
        tab_questions: 'Fragen',
        tab_minigames: 'Minispiele',
        tab_qrcodes: 'QR-Codes',
        tab_password: 'Passwort',
        tab_photo: 'Foto',
        tab_ar: 'AR',
        tab_display: 'Anzeige',
        tab_language: 'Sprache',
        qr_management: 'QR-Code-Verwaltung',
        password_tab: 'Passwort zum Enth√ºllen',
        password_description: 'Hier sehen Sie das Passwort, das die Spieler w√§hrend des Spiels enth√ºllen m√ºssen.',
        photo_tab: 'Fotogalerie',
        photo_description: 'Hier sehen Sie die von Spielern hochgeladenen Fotos.',
        ar_tab: 'Augmented Reality (AR)',
        ar_description: 'AR-Funktionen werden hier verf√ºgbar sein.',
        display_tab: 'Anzeigeeinstellungen',
        display_screens: 'Anzahl externer Bildschirme:',
        one_screen: '1 Bildschirm',
        two_screens: '2 Bildschirme',
        language_tab: 'Spracheinstellungen',
        game_info: 'Spielinformationen',
        player_count: 'Anzahl der Spieler:',
        completion_percentage: 'Abschlussgrad:',
        language_host_label: 'Moderatorsprache:',
        time_left: 'Verbleibende Zeit:',
        time_net: 'Spielzeit (netto):',
        time_gross: 'Spielzeit (brutto):',
        current_bonus: 'Aktueller Bonus:',
        current_speed: 'Aktuelles Tempo:',
        game_status_label: 'Spielstatus:',
        game_status_waiting: 'Warte auf Start',
        game_status_active: 'Start. Spiel aktiv',
        game_status_paused: 'Pause',
        game_status_stopped: 'Stop. Spiel beendet',
        pre_game_settings: 'Spielsteuerung',
        game_duration_label: 'Spielzeit (Minuten):',
        game_duration_help: 'Vor dem Spiel: Zeit einstellen. W√§hrend des Spiels: Zeit √§ndern (erfordert Passwort)',
        set_time_btn: 'OK',
        player_language: 'Spielersprache',
        host_language: 'Moderatorsprache',
        lang_polish: 'Polnische Sprache',
        lang_english: 'Englische Sprache',
        lang_german: 'Deutsche Sprache',
        start_game: 'Spiel starten',
        in_game_settings: 'Spielgeschwindigkeit und Punktzahl',
        points_bonus: 'Punktebonus:',
        time_speed: 'Zeitgeschwindigkeit:',
        pause: 'Pause',
        resume: 'Fortsetzen',
        force_win: 'Vorzeitiger Sieg',
        stop_game: 'Spiel stoppen',
        reset_game: 'Spiel zur√ºcksetzen',
        quick_access: 'Schnellzugriff auf Registerkarten:',
        questions_management: 'Fragenverwaltung',
        players_management: 'Spielerverwaltung',
        add_question: 'Frage hinzuf√ºgen',
        question_modal_title: 'Frage hinzuf√ºgen',
        question_text: 'Fragetext:',
        answers: 'Antworten:',
        difficulty_level: 'Schwierigkeitsgrad:',
        easy: 'Leicht',
        medium: 'Mittel',
        hard: 'Schwer',
        letter_reveal: 'Buchstabe zum Enth√ºllen:',
        cancel: 'Abbrechen',
        save: 'Speichern',
        edit: 'Bearbeiten',
        delete: 'L√∂schen',
        shown: 'Angezeigt',
        correct: 'Richtig',
        times: 'mal',
        admin_impersonate: 'Sie sind als Administrator im Host-Panel angemeldet.',
        back_to_admin: 'Zur√ºck zum Admin-Panel',
        warn: 'Warnen',
        warnings: 'Warnungen',
        question_category: 'Fragenkategorie:',
        category_company: 'Firma',
        category_world: 'Welt',
        host_messages: 'Nachrichten auf Spielbildschirm',
        messages_description: 'Senden Sie eine Nachricht, die auf dem Hauptspielbildschirm angezeigt wird. Verwenden Sie dies, um wichtige Informationen mit allen Teilnehmern zu teilen.',
        message_label: 'Nachrichteninhalt (max. 500 Zeichen):',
        send_message: 'Nachricht senden',
        password_preview: 'Passwort',
        tab_timing: 'Zeit & Tempo',
        timing_settings: 'Spielzeit und Geschwindigkeit',
    }
};

let currentLanguage = 'pl';
let currentEditingQuestionId = null;
const EVENT_ID = {{ event.id }};
const IS_SUPERHOST = {{ 'true' if is_superhost else 'false' }};

function translatePage(lang) {
    currentLanguage = lang;
    document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (translations[lang][key]) {
            if (el.tagName === 'INPUT' && el.type === 'button') {
                el.value = translations[lang][key];
            } else {
                el.textContent = translations[lang][key];
            }
        }
    });
    
    // Update pause button text based on state
    const pauseBtn = document.getElementById('pause-btn');
    if (pauseBtn && (pauseBtn.textContent.includes('Wzn√≥w') || pauseBtn.textContent.includes('Resume'))) {
        pauseBtn.textContent = translations[lang]['resume'];
    }
    
    // Update game status text
    updateGameStatusText();
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// ‚úÖ Funkcja aktualizujƒÖca tekst statusu gry
function updateGameStatusText() {
    const statusEl = document.getElementById('info-game-status');
    if (!statusEl) return;
    
    const currentStatus = statusEl.dataset.status;
    if (!currentStatus) return;
    
    const statusTexts = {
        'waiting': translations[currentLanguage].game_status_waiting,
        'active': translations[currentLanguage].game_status_active,
        'paused': translations[currentLanguage].game_status_paused,
        'stopped': translations[currentLanguage].game_status_stopped
    };
    
    statusEl.textContent = statusTexts[currentStatus] || statusTexts['waiting'];
}

document.addEventListener('DOMContentLoaded', function () {
    console.log('üéÆ HOST PANEL INITIALIZING - Event ID:', EVENT_ID);
    
    const socket = io();
    const questionModal = new bootstrap.Modal(document.getElementById('questionModal'));

        // =====================================================================
    // ‚úÖ NOWE: Przekierowanie do zak≈Çadki Has≈Ço po klikniƒôciu w pole
    // =====================================================================
    const passwordCard = document.getElementById('password-preview-card');
    if (passwordCard) {
        passwordCard.addEventListener('click', () => {
            const passwordTab = document.querySelector('button[data-bs-target="#password"]');
            if (passwordTab) {
                const tab = new bootstrap.Tab(passwordTab);
                tab.show();
            }
        });
    }
    
    // =====================================================================
    // SZYBKI DOSTƒòP DO ZAK≈ÅADEK
    // =====================================================================
    document.querySelectorAll('.quick-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            const tabButton = document.querySelector(`button[data-bs-target="#${tabName}"]`);
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
            }
        });
    });
    
    // =====================================================================
    // WY≈öWIETLACZ - PRZE≈ÅƒÑCZANIE LICZBY EKRAN√ìW
    // =====================================================================
    document.getElementById('display-screens-controls')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-value]');
        if (btn) {
            const screensCount = btn.dataset.value;
            
            // Update active state
            document.querySelectorAll('#display-screens-controls button').forEach(b => b.classList.remove('active-modifier'));
            btn.classList.add('active-modifier');
            
            // Update status message
            const statusDiv = document.getElementById('display-status');
            if (statusDiv) {
                statusDiv.innerHTML = `Aktualnie uruchomione: <strong>${screensCount} ${screensCount === '1' ? 'ekran' : 'ekrany'}</strong>`;
            }
            
            // Mo≈ºesz tutaj dodaƒá zapisywanie ustawie≈Ñ do GameState je≈õli potrzebne
            console.log('Liczba ekran√≥w ustawiona na:', screensCount);
        }
    });
    
    // =====================================================================
    // SEKCJA KOD√ìW QR - TYLKO DLA SUPERHOST
    // =====================================================================
    if (IS_SUPERHOST) {
        // Za≈Çaduj liczby kod√≥w po otwarciu zak≈Çadki
        document.querySelector('button[data-bs-target="#qrcodes"]')?.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/host/qrcodes/counts');
                if (response.ok) {
                    const counts = await response.json();
                    document.getElementById('red-count').value = counts.red || 0;
                    document.getElementById('white_trap-count').value = counts.white_trap || 0;
                    document.getElementById('green-count').value = counts.green || 0;
                    document.getElementById('pink-count').value = counts.pink || 0;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd ≈Çadowania kod√≥w QR:', error);
            }
        });

        // Generowanie kod√≥w QR
        document.getElementById('save-qrcodes').addEventListener('click', async () => {
            const statusEl = document.getElementById('qrcodes-status');
            const payload = {
                counts: {
                    red: document.getElementById('red-count').value,
                    white_trap: document.getElementById('white_trap-count').value,
                    green: document.getElementById('green-count').value,
                    pink: document.getElementById('pink-count').value,
                }
            };
            try {
                const response = await fetch('/api/host/qrcodes/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                statusEl.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
            } catch (error) {
                statusEl.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });

        // Link do podglƒÖdu kod√≥w QR
        document.getElementById('preview-qrcodes-link').href = `{{ url_for('list_qrcodes_public', event_id=event.id) }}`;
    }
    
    // =====================================================================
    // GRACZE
    // =====================================================================
    function loadPlayers() {
        fetch('/api/host/players')
            .then(res => res.json())
            .then(players => {
                const list = document.getElementById('players-list');
                if (players.length === 0) {
                    list.innerHTML = `<p class="text-muted">Brak graczy</p>`;
                    return;
                }
                
                list.innerHTML = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>${translations[currentLanguage].player_count.replace(':', '')}</th>
                                <th>Punkty</th>
                                <th>${translations[currentLanguage].warnings}</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${players.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.score}</td>
                                    <td>${p.warnings}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning warn-player-btn" data-id="${p.id}">${translations[currentLanguage].warn}</button>
                                        <button class="btn btn-sm btn-danger delete-player-btn" data-id="${p.id}">${translations[currentLanguage].delete}</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Attach event listeners
                document.querySelectorAll('.warn-player-btn').forEach(btn => {
                    btn.addEventListener('click', () => warnPlayer(parseInt(btn.dataset.id)));
                });
                document.querySelectorAll('.delete-player-btn').forEach(btn => {
                    btn.addEventListener('click', () => deletePlayer(parseInt(btn.dataset.id)));
                });
            });
    }
    
    async function warnPlayer(id) {
        try {
            const response = await fetch(`/api/host/player/${id}/warn`, { method: 'POST' });
            if (!response.ok) throw new Error('B≈ÇƒÖd ostrze≈ºenia gracza');
            loadPlayers();
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    }
    
    async function deletePlayer(id) {
        if (!confirm('Czy na pewno chcesz usunƒÖƒá tego gracza?')) return;
        
        try {
            const response = await fetch(`/api/host/player/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('B≈ÇƒÖd usuwania gracza');
            loadPlayers();
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    }
    
    document.querySelector('button[data-bs-target="#players"]')?.addEventListener('click', loadPlayers);
    
    // =====================================================================
    // JƒòZYK I TRANSLACJA
    // =====================================================================
    document.getElementById('lang-host-controls')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-value]');
        if (btn) {
            const lang = btn.dataset.value;
            translatePage(lang);
            sendGameControl('language_host', lang);
            
            // Update active state
            document.querySelectorAll('#lang-host-controls button').forEach(b => b.classList.remove('active-modifier'));
            btn.classList.add('active-modifier');
        }
    });
    
    document.getElementById('lang-player-controls')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-value]');
        if (btn) {
            const lang = btn.dataset.value;
            sendGameControl('language_player', lang);
            
            // Update active state
            document.querySelectorAll('#lang-player-controls button').forEach(b => b.classList.remove('active-modifier'));
            btn.classList.add('active-modifier');
        }
    });
    
    // Difficulty buttons
    document.getElementById('difficulty-buttons').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn) {
            document.querySelectorAll('#difficulty-buttons .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    });

    // Category buttons
    document.getElementById('category-buttons').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn) {
            document.querySelectorAll('#category-buttons .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    });
    
    // =====================================================================
    // PYTANIA
    // =====================================================================
    function loadQuestions() {
        fetch('/api/host/questions')
            .then(res => res.json())
            .then(questions => {
                const list = document.getElementById('questions-list');
                if (questions.length === 0) {
                    list.innerHTML = `<p class="text-muted">${translations[currentLanguage].add_question}</p>`;
                    return;
                }
                
                list.innerHTML = questions.map((q, index) => {
                    const percentage = q.times_shown > 0 ? Math.round((q.times_correct / q.times_shown) * 100) : 0;
                    return `
                        <div class="question-item d-flex align-items-start">
                            <div class="me-3">
                                <strong>${index + 1}.</strong>
                            </div>
                            <div class="flex-grow-1">
                                <p class="mb-2">${q.text}</p>
                                <div class="question-stats">
                                    <span class="badge bg-info">${translations[currentLanguage][q.difficulty] || q.difficulty}</span>
                                    <span>${translations[currentLanguage].shown}: ${q.times_shown}</span> | 
                                    <span>${translations[currentLanguage].correct}: ${q.times_correct}</span> | 
                                    <span>${percentage}%</span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2 edit-question-btn" data-id="${q.id}" data-translate="edit">${translations[currentLanguage].edit}</button>
                                <button class="btn btn-sm btn-outline-danger delete-question-btn" data-id="${q.id}" data-translate="delete">${translations[currentLanguage].delete}</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Attach event listeners
                document.querySelectorAll('.edit-question-btn').forEach(btn => {
                    btn.addEventListener('click', () => editQuestion(parseInt(btn.dataset.id)));
                });
                document.querySelectorAll('.delete-question-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteQuestion(parseInt(btn.dataset.id)));
                });
            });
    }
    
    document.getElementById('add-question-btn').addEventListener('click', () => {
        currentEditingQuestionId = null;
        document.getElementById('modal-question-text').value = '';
        document.getElementById('modal-answer-a').value = '';
        document.getElementById('modal-answer-b').value = '';
        document.getElementById('modal-answer-c').value = '';
        document.getElementById('modal-letter').value = 'X';
        document.querySelectorAll('input[name="correct-answer"]').forEach(r => r.checked = false);
        document.getElementById('correct-a').checked = true;
        document.querySelectorAll('#difficulty-buttons .btn').forEach(b => b.classList.remove('active'));
        document.querySelector('#difficulty-buttons .btn[data-difficulty="easy"]').classList.add('active');
        document.querySelectorAll('#category-buttons .btn').forEach(b => b.classList.remove('active'));
        document.querySelector('#category-buttons .btn[data-category="company"]').classList.add('active');
        document.querySelector('.modal-title').textContent = translations[currentLanguage].question_modal_title;
        questionModal.show();
    });
    
    document.getElementById('save-question-btn').addEventListener('click', async () => {
        const text = document.getElementById('modal-question-text').value.trim();
        const answerA = document.getElementById('modal-answer-a').value.trim();
        const answerB = document.getElementById('modal-answer-b').value.trim();
        const answerC = document.getElementById('modal-answer-c').value.trim();
        const correctAnswer = document.querySelector('input[name="correct-answer"]:checked')?.value;
        const difficulty = document.querySelector('#difficulty-buttons .btn.active')?.dataset.difficulty || 'easy';
        const category = document.querySelector('#category-buttons .btn.active')?.dataset.category || 'company';
        const letter = document.getElementById('modal-letter').value.toUpperCase() || 'X';
        
        if (!text || !answerA || !answerB || !answerC || !correctAnswer) {
            alert('Wype≈Çnij wszystkie pola!');
            return;
        }
        
        const payload = {
            text,
            answers: [answerA, answerB, answerC],
            correctAnswer,
            difficulty,
            letterToReveal: letter,
            category: category
        };
        
        try {
            let response;
            if (currentEditingQuestionId) {
                response = await fetch(`/api/host/question/${currentEditingQuestionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } else {
                response = await fetch('/api/host/questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }
            
            if (!response.ok) throw new Error('B≈ÇƒÖd zapisu pytania');
            
            questionModal.hide();
            loadQuestions();
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    });
    
    async function editQuestion(id) {
        try {
            const response = await fetch('/api/host/questions');
            const questions = await response.json();
            const question = questions.find(q => q.id === id);
            
            if (!question) return;
            
            currentEditingQuestionId = id;
            document.getElementById('modal-question-text').value = question.text;
            document.getElementById('modal-answer-a').value = question.answers[0];
            document.getElementById('modal-answer-b').value = question.answers[1];
            document.getElementById('modal-answer-c').value = question.answers[2];
            document.getElementById('modal-letter').value = question.letterToReveal;
            
            document.getElementById(`correct-${question.correctAnswer.toLowerCase()}`).checked = true;
            
            document.querySelectorAll('#difficulty-buttons .btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`#difficulty-buttons .btn[data-difficulty="${question.difficulty}"]`)?.classList.add('active');
            
            document.querySelectorAll('#category-buttons .btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`#category-buttons .btn[data-category="${question.category}"]`)?.classList.add('active');
            
            document.querySelector('.modal-title').textContent = translations[currentLanguage].edit + ' ' + translations[currentLanguage].question_text.toLowerCase();
            questionModal.show();
        } catch (error) {
            alert('B≈ÇƒÖd ≈Çadowania pytania: ' + error.message);
        }
    }
    
    async function deleteQuestion(id) {
        if (!confirm('Czy na pewno chcesz usunƒÖƒá to pytanie?')) return;
        
        try {
            const response = await fetch(`/api/host/question/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('B≈ÇƒÖd usuwania pytania');
            loadQuestions();
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    }
    
    document.querySelector('button[data-bs-target="#questions"]')?.addEventListener('click', loadQuestions);

    // =====================================================================
    // MINIGRY
    // =====================================================================
    function loadMinigamesStatus() {
        fetch('/api/host/minigames/status')
            .then(res => res.json())
            .then(data => {
                // Tetris
                const tetrisToggle = document.getElementById('tetris-toggle');
                const tetrisStatus = document.getElementById('tetris-status');
                if (tetrisToggle && tetrisStatus) {
                    tetrisToggle.checked = data.tetris_enabled;
                    tetrisStatus.textContent = data.tetris_enabled ? 'Aktywny' : 'Nieaktywny';
                    tetrisStatus.className = data.tetris_enabled ? 'badge bg-success' : 'badge bg-secondary';
                }

                // Arkanoid
                const arkanoidToggle = document.getElementById('arkanoid-toggle');
                const arkanoidStatus = document.getElementById('arkanoid-status');
                if (arkanoidToggle && arkanoidStatus) {
                    arkanoidToggle.checked = data.arkanoid_enabled;
                    arkanoidStatus.textContent = data.arkanoid_enabled ? 'Aktywny' : 'Nieaktywny';
                    arkanoidStatus.className = data.arkanoid_enabled ? 'badge bg-success' : 'badge bg-secondary';
                }

                // Snake
                const snakeToggle = document.getElementById('snake-toggle');
                const snakeStatus = document.getElementById('snake-status');
                if (snakeToggle && snakeStatus) {
                    snakeToggle.checked = data.snake_enabled;
                    snakeStatus.textContent = data.snake_enabled ? 'Aktywny' : 'Nieaktywny';
                    snakeStatus.className = data.snake_enabled ? 'badge bg-success' : 'badge bg-secondary';
                }
            });
    }
    
    // Tetris toggle
    document.getElementById('tetris-toggle')?.addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        const statusEl = document.getElementById('tetris-status');
        const infoEl = document.getElementById('minigames-info');
        try {
            const response = await fetch('/api/host/minigames/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_type: 'tetris', enabled })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            statusEl.textContent = enabled ? 'Aktywny' : 'Nieaktywny';
            statusEl.className = enabled ? 'badge bg-success' : 'badge bg-secondary';
            infoEl.textContent = result.message;
            infoEl.style.display = 'block';
            setTimeout(() => { infoEl.style.display = 'none'; }, 3000);
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
            e.target.checked = !enabled;
        }
    });
    
    // Arkanoid toggle
    document.getElementById('arkanoid-toggle')?.addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        const statusEl = document.getElementById('arkanoid-status');
        const infoEl = document.getElementById('minigames-info');
        try {
            const response = await fetch('/api/host/minigames/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_type: 'arkanoid', enabled })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            statusEl.textContent = enabled ? 'Aktywny' : 'Nieaktywny';
            statusEl.className = enabled ? 'badge bg-success' : 'badge bg-secondary';
            infoEl.textContent = result.message;
            infoEl.style.display = 'block';
            setTimeout(() => { infoEl.style.display = 'none'; }, 3000);
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
            e.target.checked = !enabled;
        }
    });

    // Snake toggle
    document.getElementById('snake-toggle')?.addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        const statusEl = document.getElementById('snake-status');
        const infoEl = document.getElementById('minigames-info');
        try {
            const response = await fetch('/api/host/minigames/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ game_type: 'snake', enabled })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            statusEl.textContent = enabled ? 'Aktywny' : 'Nieaktywny';
            statusEl.className = enabled ? 'badge bg-success' : 'badge bg-secondary';
            infoEl.textContent = result.message;
            infoEl.style.display = 'block';
            setTimeout(() => { infoEl.style.display = 'none'; }, 3000);
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
            e.target.checked = !enabled;
        }
    });

    document.querySelector('button[data-bs-target="#minigames"]')?.addEventListener('click', loadMinigamesStatus);
        
    // =====================================================================
    // STEROWANIE GRƒÑ
    // =====================================================================
    const infoElements = {
        playerCount: document.getElementById('info-player-count'),
        completionPercentage: document.getElementById('info-completion-percentage'),
        language: document.getElementById('info-language'),
        timeLeft: document.getElementById('info-time-left'),
        timeElapsed: document.getElementById('info-time-elapsed'),
        timeElapsedPauses: document.getElementById('info-time-elapsed-pauses'),
        bonus: document.getElementById('info-bonus'),
        speed: document.getElementById('info-speed'),
        gameStatus: document.getElementById('info-game-status')
    };
    
    let isTimerRunning = false;
    let isGameActive = false;
    
    async function sendGameControl(control, value = null) {
        console.log('üéÆ Sending game control:', control, value);
        try {
            const response = await fetch('/api/host/game_control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ control, value })
            });
            if (!response.ok) throw new Error('Server error');
            const result = await response.json();
            console.log('‚úÖ Game control response:', result);
        } catch (error) {
            console.error('‚ùå Control error:', error);
        }
    }
    
    function updateUI(state) {
        console.log('üîÑ Updating UI with state:', state);
        
        // Update player count
        if (infoElements.playerCount) infoElements.playerCount.textContent = state.player_count || 0;
        
        // ‚úÖ Update completion percentage
        if (infoElements.completionPercentage) {
            infoElements.completionPercentage.textContent = `${state.completion_percentage || 0}%`;
        }
        
        // Update language display
        if (infoElements.language) {
            const langMap = { 'pl': 'Polski', 'en': 'English', 'de': 'Deutsch' };
            const langText = langMap[state.language_host] || 'Polski';
            infoElements.language.textContent = langText;
        }
        
        // Update bonus display
        if (infoElements.bonus) {
            const bonusVal = state.bonus_multiplier || 1;
            infoElements.bonus.textContent = bonusVal > 1 ? `x${bonusVal}` : 'Brak';
            
            // Update button states
            document.querySelectorAll('[data-control="bonus"]').forEach(btn => {
                btn.classList.toggle('active-modifier', btn.dataset.value === String(bonusVal));
            });
        }
        
        // Update speed display
        if (infoElements.speed) {
            const speedVal = state.time_speed || 1;
            infoElements.speed.textContent = `x${speedVal}`;
            
            // Update button states
            document.querySelectorAll('[data-control="speed"]').forEach(btn => {
                btn.classList.toggle('active-modifier', btn.dataset.value === String(speedVal));
            });
        }
        
        // ‚úÖ Update game status
        if (infoElements.gameStatus) {
            const statusEl = infoElements.gameStatus;
            const status = state.game_status || 'waiting';
            statusEl.dataset.status = status;
            
            // Remove all status classes
            statusEl.classList.remove('status-waiting', 'status-active', 'status-paused', 'status-stopped');
            
            // Add appropriate class
            statusEl.classList.add(`status-${status}`);
            
            // Update text
            updateGameStatusText();
        }
        
        // Update pause button text
        const pauseBtn = document.getElementById('pause-btn');
        if (pauseBtn) {
            isTimerRunning = state.is_timer_running;
            pauseBtn.textContent = state.is_timer_running 
                ? translations[currentLanguage].pause 
                : translations[currentLanguage].resume;
        }
        
        // Store game active state
        isGameActive = state.game_active;
        
        // ‚úÖ LOGIKA AKTYWACJI/DEAKTYWACJI PRZYCISK√ìW
        const startGameBtn = document.getElementById('start-game');
        const pauseGameBtn = document.getElementById('pause-btn');
        const stopGameBtn = document.getElementById('stop-game');
        const resetGameBtn = document.getElementById('reset-game');
        
        if (state.game_active) {
            // GRA JEST AKTYWNA
            // Start - nieaktywny (blady)
            if (startGameBtn) {
                startGameBtn.disabled = true;
                startGameBtn.classList.add('opacity-50');
            }
            
            // Pauza - aktywny
            if (pauseGameBtn) {
                pauseGameBtn.disabled = false;
                pauseGameBtn.classList.remove('opacity-50');
            }
            
            // Stop - aktywny
            if (stopGameBtn) {
                stopGameBtn.disabled = false;
                stopGameBtn.classList.remove('opacity-50');
            }
            
            // Reset - aktywny
            if (resetGameBtn) {
                resetGameBtn.disabled = false;
                resetGameBtn.classList.remove('opacity-50');
            }
        } else {
            // GRA NIE JEST AKTYWNA
            // Start - aktywny
            if (startGameBtn) {
                startGameBtn.disabled = false;
                startGameBtn.classList.remove('opacity-50');
            }
            
            // Pauza - nieaktywny (blady)
            if (pauseGameBtn) {
                pauseGameBtn.disabled = true;
                pauseGameBtn.classList.add('opacity-50');
            }
            
            // Stop - nieaktywny (blady)
            if (stopGameBtn) {
                stopGameBtn.disabled = true;
                stopGameBtn.classList.add('opacity-50');
            }
            
            // Reset - nieaktywny (blady)
            if (resetGameBtn) {
                resetGameBtn.disabled = true;
                resetGameBtn.classList.add('opacity-50');
            }
        }
        
        // Enable/disable fieldsets based on game state
        const preGameFieldset = document.getElementById('pre-game-settings');
        const inGameFieldset = document.getElementById('in-game-settings');
        const gameDurationInput = document.getElementById('game-duration-input-2');
        const setTimeBtn = document.getElementById('set-time-btn-2');
        
        if (state.game_active) {
            preGameFieldset.disabled = false; // ‚úÖ Zawsze dostƒôpne
            inGameFieldset.disabled = false;
            // ‚úÖ Zmie≈Ñ tekst przycisku podczas gry
            if (setTimeBtn) setTimeBtn.textContent = translations[currentLanguage].set_time_btn || 'OK';
        } else {
            preGameFieldset.disabled = false;
            inGameFieldset.disabled = true;
            // ‚úÖ Przywr√≥ƒá oryginalny tekst przycisku
            if (setTimeBtn) setTimeBtn.textContent = translations[currentLanguage].set_time_btn || 'OK';
        }
        
        // ‚úÖ Aktualizuj wy≈õwietlanie has≈Ça
        const passwordDisplay = document.getElementById('current-password-display');
        if (passwordDisplay && state.password) {
            passwordDisplay.textContent = state.password.split('').join(' ');
        }
    }
    
    // Socket.IO event handlers
    socket.on('connect', () => {
        console.log('‚úÖ Socket connected, joining room for event:', EVENT_ID);
        socket.emit('join', { event_id: EVENT_ID });
    });
    
    socket.on('disconnect', () => {
        console.log('‚ùå Socket disconnected');
    });
    
    socket.on('game_state_update', (state) => {
        console.log('üì° Game state update received:', state);
        updateUI(state);
    });
    
    socket.on('timer_tick', (data) => {
        console.log('‚è±Ô∏è Timer tick:', data);
        if (infoElements.timeLeft) infoElements.timeLeft.textContent = formatTime(data.time_left);
        if (infoElements.timeElapsed) infoElements.timeElapsed.textContent = formatTime(data.time_elapsed);
        // ‚úÖ Zawsze aktualizuj czas brutto (r√≥wnie≈º podczas pauzy)
        if (infoElements.timeElapsedPauses) infoElements.timeElapsedPauses.textContent = formatTime(data.time_elapsed_with_pauses);
    });
    
    socket.on('game_over', () => {
        alert('Czas minƒÖ≈Ç! Gra zako≈Ñczona.');
    });
    
    socket.on('game_forced_win', (data) => {
        alert(data.message);
    });
    
    socket.on('password_update', (password) => {
        const passwordDisplay = document.getElementById('current-password-display');
        if (passwordDisplay) {
            passwordDisplay.textContent = password.split('').join(' ');
        }
        
        // ‚úÖ NOWE: Aktualizuj r√≥wnie≈º podglƒÖd has≈Ça w zak≈Çadce Gra
        loadPasswordState();
    });
    
    // Initial state load
    console.log('üîÑ Loading initial state...');
    fetch('/api/host/state')
        .then(res => res.json())
        .then(state => {
            console.log('‚úÖ Initial state loaded:', state);
            updateUI(state);
            // Inicjalizacja jƒôzyka prowadzƒÖcego
            if (state.language_host && state.language_host !== 'pl') {
                translatePage(state.language_host);
                document.querySelectorAll('#lang-host-controls button').forEach(b => b.classList.remove('active-modifier'));
                document.querySelector(`#lang-host-controls button[data-value="${state.language_host}"]`)?.classList.add('active-modifier');
            }
            // Inicjalizacja jƒôzyka graczy
            if (state.language_player && state.language_player !== 'pl') {
                document.querySelectorAll('#lang-player-controls button').forEach(b => b.classList.remove('active-modifier'));
                document.querySelector(`#lang-player-controls button[data-value="${state.language_player}"]`)?.classList.add('active-modifier');
            }
            
            // ‚úÖ Za≈Çaduj stan has≈Ça od razu przy inicjalizacji - WYMUSZONY
            setTimeout(() => loadPasswordState(), 100);
        })
        .catch(error => console.error('‚ùå Error loading initial state:', error));
    
    // ‚úÖ NOWY: Ujednolicona obs≈Çuga przycisku "OK"
    document.getElementById('set-time-btn-2')?.addEventListener('click', async () => {
        const minutes = parseInt(document.getElementById('game-duration-input-2').value);
        console.log('üéÆ Setting time:', minutes, 'minutes, Game active:', isGameActive);
        
        if (isNaN(minutes) || minutes < 1) {
            alert('Proszƒô wprowadziƒá poprawny czas gry (minimum 1 minuta).');
            return;
        }
        
        if (!isGameActive) {
            // ‚úÖ PRZED GRƒÑ: Po prostu zapisz warto≈õƒá (nie uruchamiaj gry)
            alert(`Czas gry ustawiony na ${minutes} minut. Kliknij "Start Gry", aby rozpoczƒÖƒá.`);
        } else {
            // ‚úÖ PODCZAS GRY: Zmie≈Ñ czas (wymaga has≈Ça)
            const password = prompt('Wprowad≈∫ has≈Ço Hosta, aby zmieniƒá czas gry:');
            if (!password) return;
            
            if (!confirm(`Czy na pewno chcesz zmieniƒá czas gry na ${minutes} minut?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/host/adjust_time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        new_minutes: minutes,
                        password: password 
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'B≈ÇƒÖd zmiany czasu');
                }
                
                alert(result.message || 'Czas gry zosta≈Ç zmieniony!');
            } catch (error) {
                alert('B≈ÇƒÖd: ' + error.message);
            }
        }
    });
    
    // Start game button
    document.getElementById('start-game')?.addEventListener('click', async () => {
        const minutes = parseInt(document.getElementById('game-duration-input-2').value);
        console.log('üéÆ Starting game with', minutes, 'minutes');
        
        if (isNaN(minutes) || minutes < 1) {
            alert('Proszƒô wprowadziƒá poprawny czas gry (minimum 1 minuta).');
            return;
        }
        
        if (!confirm(`Czy na pewno chcesz rozpoczƒÖƒá nowƒÖ grƒô na ${minutes} minut?`)) {
            return;
        }
        
        try {
            console.log('üì§ Sending start game request...');
            const response = await fetch('/api/host/start_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ minutes })
            });
            
            const result = await response.json();
            console.log('üì• Start game response:', result);
            
            if (!response.ok) {
                throw new Error(result.error || 'Nieznany b≈ÇƒÖd uruchamiania gry');
            }
            
            console.log('‚úÖ Game started successfully');
            alert(result.message || 'Gra rozpoczƒôta!');
        } catch (error) {
            console.error('‚ùå Error starting game:', error);
            alert('B≈ÇƒÖd podczas uruchamiania gry: ' + error.message);
        }
    });
    
    // Stop game button
    document.getElementById('stop-game')?.addEventListener('click', async () => {
        const password = prompt('Wprowad≈∫ has≈Ço Hosta, aby zako≈Ñczyƒá grƒô:');
        if (!password) return;
        
        try {
            const response = await fetch('/api/host/stop_game', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'B≈ÇƒÖd zatrzymywania gry');
            }
            
            alert(result.message || 'Gra zatrzymana');
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    });
    
    // Reset game button
    document.getElementById('reset-game')?.addEventListener('click', async () => {
        const password = prompt('Wprowad≈∫ has≈Ço Hosta, aby zresetowaƒá grƒô:');
        if (!password) return;
        
        if (!confirm('Czy na pewno chcesz zresetowaƒá ca≈ÇƒÖ grƒô? To usunie wszystkich graczy, pytania i dane gry!')) {
            return;
        }
        
        try {
            // Weryfikuj has≈Ço przez endpoint stop_game (mo≈ºesz te≈º dodaƒá osobny endpoint)
            // Na razie wykorzystamy istniejƒÖcy endpoint do resetu z admina
            const response = await fetch(`/api/admin/event/${EVENT_ID}/reset`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'B≈ÇƒÖd resetowania gry');
            }
            
            alert(result.message || 'Gra zosta≈Ça zresetowana');
            location.reload(); // Od≈õwie≈º stronƒô
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
        }
    });
    
    // In-game controls
    document.getElementById('game-controls')?.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-control]');
        if (!btn) return;
        
        const control = btn.dataset.control;
        const value = btn.dataset.value;
        
        console.log('üéÆ Sending game control:', control, value);
        sendGameControl(control, value);
    });

// =====================================================================
    // ‚úÖ KOMUNIKATY NA EKRAN GRY
    // =====================================================================
    const messageInput = document.getElementById('host-message-input');
    const charCount = document.getElementById('message-char-count');
    const sendMessageBtn = document.getElementById('send-message-btn');
    const messageStatus = document.getElementById('message-status');

    if (messageInput && charCount) {
        messageInput.addEventListener('input', () => {
            charCount.textContent = messageInput.value.length;
        });
    }

    // Wysy≈Çanie komunikatu
    if (sendMessageBtn) {
        sendMessageBtn.addEventListener('click', async () => {
            const message = messageInput.value.trim();
            
            if (!message) {
                messageStatus.innerHTML = '<div class="alert alert-warning">Wpisz tre≈õƒá komunikatu</div>';
                setTimeout(() => messageStatus.innerHTML = '', 3000);
                return;
            }
            
            sendMessageBtn.disabled = true;
            sendMessageBtn.textContent = 'Wysy≈Çanie...';
            
            try {
                const response = await fetch('/api/host/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'B≈ÇƒÖd wysy≈Çania');
                }
                
                messageStatus.innerHTML = '<div class="alert alert-success">‚úÖ Komunikat wys≈Çany!</div>';
                messageInput.value = '';
                charCount.textContent = '0';
                
                setTimeout(() => messageStatus.innerHTML = '', 3000);
            } catch (error) {
                messageStatus.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
            } finally {
                sendMessageBtn.disabled = false;
                sendMessageBtn.textContent = translations[currentLanguage].send_message || 'Wy≈õlij komunikat';
            }
        });
    }
    
    console.log('‚úÖ HOST PANEL INITIALIZED');

// =====================================================================
// ZARZƒÑDZANIE HAS≈ÅEM - NOWY SYSTEM Z INDEKSAMI
// =====================================================================

    let currentPassword = 'SAPEREVENT';
    let revealedLettersIndices = new Set();
    let autoRevealEnabled = true;
    let selectedLettersForReveal = new Set();
    let passwordLetters = [];


      // ‚úÖ NOWA FUNKCJA: Renderowanie podglƒÖdu has≈Ça w zak≈Çadce Gra
    function renderGamePasswordPreview() {
        const container = document.getElementById('game-password-display');
        if (!container) return;
        
        container.innerHTML = '';
        
        for (let i = 0; i < currentPassword.length; i++) {
            const char = currentPassword[i];
            const isRevealed = revealedLettersIndices.has(i);
            
            if (char === ' ') {
                // Spacja = odstƒôp
                const spaceEl = document.createElement('div');
                spaceEl.style.width = '15px';
                spaceEl.style.height = '30px';
                container.appendChild(spaceEl);
            } else {
                // Litera = badge (czerwony lub zielony)
                const span = document.createElement('span');
                span.className = isRevealed ? 'badge bg-success' : 'badge bg-danger';
                span.textContent = char;
                span.style.fontSize = '0.9rem';      // Mniejsza czcionka
                span.style.width = '28px';           // Mniejszy rozmiar
                span.style.height = '28px';
                span.style.display = 'inline-flex';
                span.style.alignItems = 'center';
                span.style.justifyContent = 'center';
                container.appendChild(span);
            }
        }
    }
    
    async function loadPasswordState() {
        try {
            const response = await fetch('/api/host/password/state');
            const data = await response.json();
            
            currentPassword = data.password;
            autoRevealEnabled = data.mode === 'auto';
            
            revealedLettersIndices.clear();
            if (data.revealed_letters) {
                const indices = data.revealed_letters.split(',').filter(x => x);
                indices.forEach(idx => revealedLettersIndices.add(parseInt(idx)));
            }
            
            document.getElementById('password-edit-input').value = currentPassword;
            
            const autoToggle = document.getElementById('password-auto-reveal-toggle');
            const autoStatus = document.getElementById('auto-reveal-status');
            if (autoToggle && autoStatus) {
                autoToggle.checked = autoRevealEnabled;
                autoStatus.textContent = autoRevealEnabled ? 'W≈ÇƒÖczone' : 'Wy≈ÇƒÖczone';
                autoStatus.className = autoRevealEnabled ? 'badge bg-success' : 'badge bg-secondary';
            }
            
            renderPasswordLetters();
            
       // ‚úÖ NOWE: Renderuj r√≥wnie≈º podglƒÖd w zak≈Çadce Gra
            renderGamePasswordPreview();
            
        } catch (error) {
            console.error('B≈ÇƒÖd ≈Çadowania has≈Ça:', error);
        }
    }
    
    function renderPasswordLetters() {
        const container = document.getElementById('password-letters-display');
        if (!container) return;
        
        container.innerHTML = '';
        passwordLetters = [];
        selectedLettersForReveal.clear();
        
        for (let i = 0; i < currentPassword.length; i++) {
            const char = currentPassword[i];
            const isRevealed = revealedLettersIndices.has(i);
            
            passwordLetters.push({ char, index: i, revealed: isRevealed });
            
            if (char === ' ') {
                const spaceEl = document.createElement('div');
                spaceEl.style.width = '30px';
                spaceEl.style.height = '50px';
                container.appendChild(spaceEl);
            } else {
                const btn = document.createElement('button');
                btn.className = isRevealed ? 'btn btn-success' : 'btn btn-danger';
                btn.textContent = char;
                btn.disabled = false;
                btn.style.width = '50px';
                btn.style.height = '50px';
                btn.style.fontSize = '1.5rem';
                btn.style.fontWeight = 'bold';
                btn.dataset.index = i;
                
                btn.addEventListener('click', () => {
                    if (isRevealed) return;
                    
                    if (btn.classList.contains('btn-danger')) {
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-warning');
                        selectedLettersForReveal.add(i);
                    } else if (btn.classList.contains('btn-warning')) {
                        btn.classList.remove('btn-warning');
                        btn.classList.add('btn-danger');
                        selectedLettersForReveal.delete(i);
                    }
                    
                    const confirmBtn = document.getElementById('reveal-selected-letters-btn');
                    if (confirmBtn) {
                        confirmBtn.disabled = selectedLettersForReveal.size === 0;
                    }
                });
                
                container.appendChild(btn);
            }
        }
        
        const confirmBtn = document.getElementById('reveal-selected-letters-btn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
        }
        
        // ‚úÖ NOWE: Aktualizuj r√≥wnie≈º podglƒÖd w zak≈Çadce Gra
        renderGamePasswordPreview();
    }
    
    document.getElementById('password-edit-ok-btn')?.addEventListener('click', async () => {
        const newPassword = document.getElementById('password-edit-input').value.trim().toUpperCase();
        const statusEl = document.getElementById('password-edit-status');
        
        if (!newPassword) {
            statusEl.innerHTML = '<div class="alert alert-warning">Has≈Ço nie mo≈ºe byƒá puste</div>';
            return;
        }
        
        if (newPassword.length > 50) {
            statusEl.innerHTML = '<div class="alert alert-warning">Has≈Ço mo≈ºe mieƒá maksymalnie 50 znak√≥w</div>';
            return;
        }
        
        try {
            const response = await fetch('/api/host/password/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: newPassword })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'B≈ÇƒÖd zapisu has≈Ça');
            }
            
            currentPassword = newPassword;
            revealedLettersIndices.clear();
            statusEl.innerHTML = '<div class="alert alert-success">‚úÖ Has≈Ço zaktualizowane!</div>';
            
            loadPasswordState();
            
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } catch (error) {
            statusEl.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
        }
    });
    
    document.getElementById('password-auto-reveal-toggle')?.addEventListener('change', async (e) => {
        const enabled = e.target.checked;
        const statusEl = document.getElementById('auto-reveal-status');
        
        try {
            const mode = enabled ? 'auto' : 'manual';
            const response = await fetch('/api/host/password/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'B≈ÇƒÖd zmiany trybu');
            }
            
            autoRevealEnabled = enabled;
            statusEl.textContent = enabled ? 'W≈ÇƒÖczone' : 'Wy≈ÇƒÖczone';
            statusEl.className = enabled ? 'badge bg-success' : 'badge bg-secondary';
            
        } catch (error) {
            alert('B≈ÇƒÖd: ' + error.message);
            e.target.checked = !enabled;
        }
    });
    
    document.getElementById('reveal-selected-letters-btn')?.addEventListener('click', async () => {
        if (selectedLettersForReveal.size === 0) return;
        
        const indices = Array.from(selectedLettersForReveal);
        const statusEl = document.getElementById('password-reveal-status');
        
        try {
            const response = await fetch('/api/host/password/reveal_manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ indices })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'B≈ÇƒÖd odkrywania liter');
            }
            
            indices.forEach(idx => revealedLettersIndices.add(idx));
            
            statusEl.innerHTML = `<div class="alert alert-success">‚úÖ ${result.message}</div>`;
            
            renderPasswordLetters();
            
            setTimeout(() => statusEl.innerHTML = '', 3000);
        } catch (error) {
            statusEl.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
        }
    });
    
    document.querySelector('button[data-bs-target="#password"]')?.addEventListener('click', loadPasswordState);

    // ==================== AI QUIZ ====================
    let aiCategories = { default_categories: [], custom_categories: [] };

    async function loadAICategories() {
        try {
            const response = await fetch('/api/host/ai-quiz/categories');
            if (!response.ok) throw new Error('B≈ÇƒÖd pobierania kategorii');
            aiCategories = await response.json();
            renderDefaultCategories();
            renderCustomCategories();
        } catch (error) {
            console.error('Error loading AI categories:', error);
            showNotification('B≈ÇƒÖd ≈Çadowania kategorii AI', 'danger');
        }
    }

    function renderDefaultCategories() {
        const container = document.getElementById('ai-default-categories');
        if (!container) return;

        container.innerHTML = aiCategories.default_categories.map(cat => `
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${cat.name}</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       id="cat-toggle-${cat.id}"
                                       ${cat.is_active ? 'checked' : ''}
                                       onchange="toggleAICategory(${cat.id})">
                            </div>
                        </div>
                        <p class="text-muted small mb-2">
                            <i class="bi bi-question-circle"></i> ${cat.question_count} pyta≈Ñ
                        </p>
                        <select class="form-select form-select-sm"
                                onchange="updateAICategoryDifficulty(${cat.id}, this.value)">
                            <option value="easy" ${cat.difficulty === 'easy' ? 'selected' : ''}>≈Åatwy</option>
                            <option value="medium" ${cat.difficulty === 'medium' ? 'selected' : ''}>≈öredni</option>
                            <option value="advanced" ${cat.difficulty === 'advanced' ? 'selected' : ''}>Zaawansowany</option>
                        </select>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderCustomCategories() {
        const container = document.getElementById('ai-custom-categories');
        const noCategories = document.getElementById('no-custom-categories');

        if (!container) return;

        if (aiCategories.custom_categories.length === 0) {
            noCategories.style.display = 'block';
            container.querySelectorAll('.card').forEach(card => card.remove());
            return;
        }

        noCategories.style.display = 'none';
        container.innerHTML = aiCategories.custom_categories.map(cat => `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">${cat.name}</h6>
                            <small class="text-muted">
                                <i class="bi bi-question-circle"></i> ${cat.question_count} pyta≈Ñ
                                ${cat.created_by_api ? '<i class="bi bi-stars text-primary ms-2" title="Wygenerowane przez AI"></i>' : ''}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm"
                                    onchange="updateAICategoryDifficulty(${cat.id}, this.value)">
                                <option value="easy" ${cat.difficulty === 'easy' ? 'selected' : ''}>≈Åatwy</option>
                                <option value="medium" ${cat.difficulty === 'medium' ? 'selected' : ''}>≈öredni</option>
                                <option value="advanced" ${cat.difficulty === 'advanced' ? 'selected' : ''}>Zaawansowany</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       id="cat-toggle-${cat.id}"
                                       ${cat.is_active ? 'checked' : ''}
                                       onchange="toggleAICategory(${cat.id})">
                                <label class="form-check-label small">Aktywna</label>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="deleteAICategory(${cat.id}, '${cat.name}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function toggleAICategory(categoryId) {
        try {
            const response = await fetch(`/api/host/ai-quiz/category/${categoryId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'B≈ÇƒÖd');
            showNotification(data.message, 'success');
            await loadAICategories();
        } catch (error) {
            console.error('Error toggling category:', error);
            showNotification(error.message, 'danger');
            await loadAICategories(); // Refresh to restore correct state
        }
    }

    async function updateAICategoryDifficulty(categoryId, difficulty) {
        try {
            const response = await fetch(`/api/host/ai-quiz/category/${categoryId}/difficulty`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ difficulty })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'B≈ÇƒÖd');
            showNotification(data.message, 'success');
        } catch (error) {
            console.error('Error updating difficulty:', error);
            showNotification(error.message, 'danger');
        }
    }

    async function deleteAICategory(categoryId, categoryName) {
        if (!confirm(`Czy na pewno usunƒÖƒá kategoriƒô "${categoryName}"? Wszystkie pytania w tej kategorii zostanƒÖ usuniƒôte.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/host/ai-quiz/category/${categoryId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'B≈ÇƒÖd');
            showNotification(data.message, 'success');
            await loadAICategories();
        } catch (error) {
            console.error('Error deleting category:', error);
            showNotification(error.message, 'danger');
        }
    }

    // Modal: Dodaj custom kategoriƒô
    const addCustomCategoryBtn = document.getElementById('add-custom-category-btn');
    const addCustomCategoryModal = new bootstrap.Modal(document.getElementById('addCustomCategoryModal'));
    const confirmAddCustomCategory = document.getElementById('confirm-add-custom-category');

    addCustomCategoryBtn?.addEventListener('click', () => {
        document.getElementById('custom-category-name').value = '';
        document.getElementById('custom-category-difficulty').value = 'medium';
        document.getElementById('use-claude-api').checked = true;
        addCustomCategoryModal.show();
    });

    confirmAddCustomCategory?.addEventListener('click', async () => {
        const name = document.getElementById('custom-category-name').value.trim();
        const difficulty = document.getElementById('custom-category-difficulty').value;
        const useClaudeAPI = document.getElementById('use-claude-api').checked;

        if (!name) {
            showNotification('Podaj nazwƒô kategorii', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/host/ai-quiz/category', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    difficulty,
                    use_claude_api: useClaudeAPI
                })
            });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'B≈ÇƒÖd');

            showNotification(data.message, 'success');
            if (data.note) {
                showNotification(data.note, 'info');
            }

            addCustomCategoryModal.hide();
            await loadAICategories();
        } catch (error) {
            console.error('Error adding category:', error);
            showNotification(error.message, 'danger');
        }
    });

    // Load AI categories when AI tab is clicked
    document.querySelector('button[data-bs-target="#ai"]')?.addEventListener('click', loadAICategories);

    // Helper function for notifications
    function showNotification(message, type = 'info') {
        // Reuse existing notification system if available, or create simple alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
    }

    // Make functions globally available for onclick handlers
    window.toggleAICategory = toggleAICategory;
    window.updateAICategoryDifficulty = updateAICategoryDifficulty;
    window.deleteAICategory = deleteAICategory;

});
</script>
{% endblock %}














